<mat-card>
  <section
    fxLayout="row"
    fxLayoutGap="10px"
  >
    <section>
      <span class="p-3 fw-bold ">Periodo Actual: {{ periodCurrent ? periodCurrent.name : "" }}</span>
      <p class="p-3">Fecha: {{ periodCurrent ? periodCurrent.rangeDate : "" }}</p>
      <h2 class="fw-bold p-0">{{ title }}</h2>
      <form
        autocomplete="off"
        [formGroup]="evaluationFormGroup"
        (ngSubmit)="confirmSave()"
      >
        <div
          class="p-3"
          fxLayout="column"
          fxLayoutGap="10px"
        >
          <mat-card class="example-card" style="max-width: 700px;">

            <mat-card-title
              fxLayout="row"
              fxLayoutGap="10px"
              fxLayoutAlign="start center"
            >
              <div class="steps-circle">1</div>
              <span class="fs-6 fw-bold">Configurar nueva evaluación</span>
            </mat-card-title>

            <mat-card-content>
              <div
                fxLayout.md="row"
                fxLayout.lg="row"
                fxLayout.xl="row"
                fxLayout.sm="row"
                fxLayout.xs="column"
                fxLayoutGap="10px"
              >
                <mat-form-field
                  fxFlex="100"
                  appearance="outline"
                >
                  <mat-label>Nombre evaluación:</mat-label>
                  <input
                    type="text"
                    formControlName="name"
                    autocomplete="off"
                    maxlength="70"
                    matInput
                  >
                  <mat-error *ngIf="controlsEvaluationForm['name'].hasError('required')">
                    El nombre es <strong>requerido</strong>.
                  </mat-error>
                  <mat-error *ngIf="controlsEvaluationForm['name'].hasError('maxlength')">
                    Se ha excedido el límite de caracteres
                  </mat-error>
                </mat-form-field>
              </div>

              <div
                fxLayout.md="row"
                fxLayout.lg="row"
                fxLayout.xl="row"
                fxLayout.xs="column"
                fxLayoutGap="10px"
              >
                <div
                  fxFlex.md="50"
                  fxFlex.lg="50"
                  fxFlex.xl="50"
                  fxFlex="100"
                >
                  <mat-form-field
                    fxFill
                    appearance="outline"
                  >
                    <mat-label>Inicia</mat-label>
                    <input
                      matInput
                      formControlName="startDate"
                      [max]="maxDateEvaluation"
                      [min]="minDateEvaluation"
                      [matDatepicker]="dpEvaluationStartDate"
                      >
                    <mat-datepicker-toggle
                      [for]="dpEvaluationStartDate"
                      matSuffix
                    ></mat-datepicker-toggle>
                    <mat-datepicker #dpEvaluationStartDate></mat-datepicker>
                    <mat-error *ngIf="controlsEvaluationForm['startDate'].hasError('required')">
                      La fecha inicia es <strong>requerido</strong>.
                    </mat-error>
                  </mat-form-field>
                </div>

                <div
                  fxFlex="100"
                  fxFlex.md="50"
                  fxFlex.lg="50"
                  fxFlex.xl="50"
                >
                  <mat-form-field
                    fxFill
                    appearance="outline"
                  >
                    <mat-label>Termina</mat-label>
                    <input
                      matInput
                      formControlName="endDate"
                      [min]="minDateEvaluation"
                      [max]="maxDateEvaluation"
                      [matDatepicker]="dpEvaluationEndDate"
                      >
                    <mat-datepicker-toggle
                      matSuffix
                      [for]="dpEvaluationEndDate">
                    </mat-datepicker-toggle>
                    <mat-datepicker #dpEvaluationEndDate></mat-datepicker>
                    <mat-error *ngIf="controlsEvaluationForm['endDate'].hasError('required')">
                      La fecha termina es <strong>requerido</strong>.
                    </mat-error>
                    <mat-error *ngIf="controlsEvaluationForm['endDate'].hasError('invalidDate')">
                      La fecha termina <strong>debe ser mayor que fecha inicia</strong>.
                    </mat-error>
                  </mat-form-field>
                </div>
              </div>

              <div
                fxLayout.md="row"
                fxLayout.lg="row"
                fxLayout.xl="row"
                fxLayout.xs="row"
              >
                <mat-divider></mat-divider>
                <div formArrayName="evaluationComponents" class="my-3">
                  <div class="mb-3"><span class="fs-8 fw-bolder">Seleccionar componentes a evaluar</span></div>
                  <section *ngFor="let component of evaluationComponents.controls; let i=index"
                    class="mb-4"
                  >
                    <div
                      fxLayout.xs="column"
                      fxLayout="row"
                      fxLayoutAlign="space-between center"
                      [formGroupName]="i"
                    >
                        <div
                          fxFlex.xs="100"
                          fxFlex.sm="10"
                          fxFlex.md="10"
                          fxFlex.xl="10"
                          fxFlex.lg="10"
                        >
                          <img
                            class="rounded-circle"
                            [src]="component.value.img"
                            alt="objetics corp"
                            width="40"
                            height="40">
                        </div>

                        <div fxLayout="column" fxFlex="80">
                          <span class="fs-10 fw-bolder">{{ component.value.title }}</span>
                          <span class="fs-8 fw-lighter">{{ component.value.subtitle }}</span>
                        </div>
                        <div fxFlex="20" fxLayoutAlign="center" >
                          <mat-checkbox formControlName="checked" color="primary"  [disabled]="isEvaluationEdit">
                          </mat-checkbox>
                        </div>
                      </div>
                      <mat-divider *ngIf=" ( i + 1 ) === evaluationComponents.controls.length" class="my-3"></mat-divider>
                  </section>
                </div>
              </div>

              <div
                fxLayout.md="column"
                fxLayout.lg="column"
                fxLayout.xl="column"
                fxLayout.xs="column"
              >
                <div class="mb-3">
                  <span class="fs-8 fw-bolder">Etapas de la evaluación</span>
                  <p class="fs-8 fw-lighter">
                    Se recomienda colocar las fechas de estas etapas una vez
                    culminado la configuracion de fechas de los componentes
                    seleccionados en la evaluación
                  </p>
                </div>
                <mat-accordion formArrayName="evaluationComponentStages" multi #accordionEvaluation="matAccordion">
                  <ng-container *ngFor="let stage of evaluationComponentStages.controls; let i = index">
                    <mat-expansion-panel [formGroupName]="i" *ngIf=" stagesEvaluation.includes(stage.value.stageId)  ">
                        <mat-expansion-panel-header>
                          <mat-panel-title
                            fxLayout="row"
                            fxLayoutGap="20px"
                            fxLayoutAlign="start start"
                          >
                            <img src="/assets/images/star-objetivo.svg" alt="objetic star">
                            <span class="fw-bolder fs-8">{{ stage.value.title }}</span>
                          </mat-panel-title>
                        </mat-expansion-panel-header>

                        <div
                          fxLayout.md="row"
                          fxLayout.lg="row"
                          fxLayout.xl="row"
                          fxLayout.xs="column"
                          fxLayoutGap="10px"
                        >
                          <div
                            fxFlex.md="50"
                            fxFlex.lg="50"
                            fxFlex.xl="50"
                            fxFlex="100"
                          >
                            <mat-form-field
                              fxFill
                              appearance="outline"
                            >
                              <mat-label>Inicia</mat-label>
                              <input
                                matInput
                                formControlName="startDate"
                                [min]="(stage.value.stageId == 4) ?startDateStageApproval : endDateMax"
                                [max]="maxDateComponentsEvaluation"
                                [matDatepicker]="dpEvaluationStageStartDate"
                              >
                              <mat-datepicker-toggle
                                [for]="dpEvaluationStageStartDate"
                                matSuffix
                              ></mat-datepicker-toggle>
                              <mat-datepicker #dpEvaluationStageStartDate></mat-datepicker>

                              <mat-error *ngIf="stageFeedback.get('startDate')?.hasError('required') && stage.value.stageId == 3">
                                La fecha inicia es <strong>requerido</strong>.
                              </mat-error>

                              <mat-error *ngIf="stageFeedback.get('startDate')?.hasError('matDatepickerMax') && stage.value.stageId == 3">
                                La fecha inicia debe ser <strong>mayor a la fecha termino de la evaluación</strong>.
                              </mat-error>

                              <mat-error *ngIf="stageFeedback.get('startDate')?.hasError('matDatepickerMin') && stage.value.stageId == 3">
                                La fecha inicia debe ser <strong>mayor a la fecha termino mayor de los componente</strong>.
                              </mat-error>

                              <mat-error *ngIf="stageApproval.get('startDate')?.hasError('required') && stage.value.stageId == 4">
                                La fecha inicia es <strong>requerido</strong>.
                              </mat-error>

                              <mat-error *ngIf="stageApproval.get('startDate')?.hasError('matDatepickerMin') && stage.value.stageId == 4">
                                La fecha inicia debe ser <strong>mayor a la fecha termina de la etapa de feedback</strong>.
                              </mat-error>

                            </mat-form-field>
                          </div>
                          <div
                            fxFlex.md="50"
                            fxFlex.lg="50"
                            fxFlex.xl="50"
                            fxFlex="100"
                          >
                            <mat-form-field
                              fxFill
                              appearance="outline"
                            >
                              <mat-label>Termina</mat-label>
                              <input
                                matInput
                                formControlName="endDate"

                                [min]="minDateComponentsEvaluation"
                                [max]="maxDateComponentsEvaluation"
                                [matDatepicker]="dpEvaluationStageEndDate"
                              >
                              <mat-datepicker-toggle
                                matSuffix
                                [for]="dpEvaluationStageEndDate">
                              </mat-datepicker-toggle>
                              <mat-datepicker #dpEvaluationStageEndDate></mat-datepicker>

                              <mat-error *ngIf="stageFeedback.get('endDate')?.hasError('required') && stage.value.stageId == 3">
                                La fecha termina es <strong>requerido</strong>.
                              </mat-error>
                              <mat-error *ngIf="stageFeedback.get('endDate')?.hasError('invalidDate') && stage.value.stageId == 3">
                                La fecha termina <strong>debe ser mayor que fecha inicia</strong>.
                              </mat-error>

                              <mat-error *ngIf="stageApproval.get('endDate')?.hasError('required') && stage.value.stageId == 4">
                                La fecha termina es <strong>requerido</strong>.
                              </mat-error>
                              <mat-error *ngIf="stageApproval.get('endDate')?.hasError('invalidDate') && stage.value.stageId == 4">
                                La fecha termina <strong>debe ser mayor que fecha inicia</strong>.
                              </mat-error>

                            </mat-form-field>
                          </div>
                        </div>
                      </mat-expansion-panel>
                  </ng-container>
                </mat-accordion>
              </div>

            </mat-card-content>
          </mat-card>
        </div>

        <div formArrayName="evaluationComponents">
          <div *ngFor="let component of evaluationComponents.controls; let i=index">
            <div [formGroupName]="i" *ngIf="component.value.checked">
              <div
                class="p-3"
                fxLayout="column"
                fxLayoutGap="10px"
              >
                <mat-card class="example-card" style="max-width: 700px;">
                  <mat-card-title
                    fxLayout="row"
                    fxLayoutGap="10px"
                    fxLayoutAlign="start center"
                  >
                    <div class="steps-circle">{{ i + 2 }}</div>
                    <span class="fs-6 fw-bold">Evaluar  {{ component.value.title }}</span>
                  </mat-card-title>

                  <mat-card-content>
                    <div
                      fxLayout.md="row"
                      fxLayout.lg="row"
                      fxLayout.xl="row"
                      fxLayout.xs="column"
                      fxLayoutGap="10px"
                      *ngIf=" competenceId != component.value.componentId; else cardCompetence "
                    >
                      <div
                        fxFlex.md="50"
                        fxFlex.lg="50"
                        fxFlex.xl="50"
                        fxFlex="100"
                      >
                        <mat-form-field fxFill appearance="outline">
                          <mat-label>Inicia</mat-label>
                          <input
                            matInput
                            formControlName="startDate"
                            [min]="minDateComponentsEvaluation"
                            [max]="maxDateComponentsEvaluation"
                            [matDatepicker]="dpCorpGoalsStartDate"
                          >
                          <mat-datepicker-toggle
                            [for]="dpCorpGoalsStartDate"
                            matSuffix
                          ></mat-datepicker-toggle>
                          <mat-datepicker #dpCorpGoalsStartDate></mat-datepicker>

                          <mat-error *ngIf="corpGoal.get('startDate')?.hasError('required') && component.value.componentId == 1">
                            La fecha termina es <strong>requerido</strong>.
                          </mat-error>
                          <mat-error *ngIf="areaGoal.get('startDate')?.hasError('required') && component.value.componentId == 2">
                            La fecha termina es <strong>requerido</strong>.
                          </mat-error>

                        </mat-form-field>
                      </div>
                      <div
                        fxFlex.md="50"
                        fxFlex.lg="50"
                        fxFlex.xl="50"
                        fxFlex="100"
                      >
                        <mat-form-field fxFill appearance="outline">
                          <mat-label>Termina</mat-label>
                          <input
                            matInput
                            formControlName="endDate"
                            [min]="minDateComponentsEvaluation"
                            [max]="maxDateComponentsEvaluation"
                            [matDatepicker]="dpCorpGoalsEndDate"
                          >
                          <mat-datepicker-toggle
                            matSuffix
                            [for]="dpCorpGoalsEndDate">
                          </mat-datepicker-toggle>
                          <mat-datepicker #dpCorpGoalsEndDate></mat-datepicker>

                          <mat-error *ngIf="corpGoal.get('endDate')?.hasError('required') && component.value.componentId == 1">
                            La fecha termina es <strong>requerido</strong>.
                          </mat-error>
                          <mat-error *ngIf="corpGoal.get('endDate')?.hasError('invalidDate') && component.value.componentId == 1">
                            La fecha termina <strong>debe ser mayor que fecha inicia</strong>.
                          </mat-error>

                          <mat-error *ngIf="areaGoal.get('endDate')?.hasError('required') && component.value.componentId == 2">
                            La fecha termina es <strong>requerido</strong>.
                          </mat-error>
                          <mat-error *ngIf="areaGoal.get('endDate')?.hasError('invalidDate') && component.value.componentId == 2">
                            La fecha termina <strong>debe ser mayor que fecha inicia</strong>.
                          </mat-error>

                        </mat-form-field>
                      </div>
                    </div>

                    <ng-template #cardCompetence>
                      <ng-container *ngTemplateOutlet="stagesCompetenceTemplate">
                      </ng-container>
                    </ng-template>
                  </mat-card-content>
                </mat-card>
              </div>
           </div>
          </div>
        </div>

        <ng-template #stagesCompetenceTemplate>
            <mat-accordion formArrayName="evaluationComponentStages" multi #accordionCompetence="matAccordion">
              <ng-container *ngFor="let stage of evaluationComponentStages.controls; let k = index">
                <mat-expansion-panel [formGroupName]="k" *ngIf=" stagesCompetence.includes(stage.value.stageId)  ">
                    <mat-expansion-panel-header>
                      <mat-panel-title
                        fxLayout="row"
                        fxLayoutGap="20px"
                        fxLayoutAlign="start start"
                      >
                        <img src="/assets/images/star-objetivo.svg" alt="objetic star">
                        <span class="fw-bolder fs-8">{{ stage.value.title }}</span>
                      </mat-panel-title>
                    </mat-expansion-panel-header>

                    <div
                      fxLayout.md="row"
                      fxLayout.lg="row"
                      fxLayout.xl="row"
                      fxLayout.xs="column"
                      fxLayoutGap="10px"
                    >
                      <div
                        fxFlex.md="50"
                        fxFlex.lg="50"
                        fxFlex.xl="50"
                        fxFlex="100"
                      >
                        <mat-form-field
                          fxFill
                          appearance="outline"
                        >
                          <mat-label>Inicia</mat-label>
                          <input
                            matInput
                            formControlName="startDate"
                            [min]="(stage.value.stageId == 2) ?startDateStageCalibration : minDateComponentsEvaluation"
                            [max]="maxDateComponentsEvaluation"
                            [matDatepicker]="dpEvaluationStageStartDate"
                          >
                          <mat-datepicker-toggle
                            [for]="dpEvaluationStageStartDate"
                            matSuffix
                          ></mat-datepicker-toggle>
                          <mat-datepicker #dpEvaluationStageStartDate></mat-datepicker>

                          <mat-error *ngIf="stageEvaluation.get('startDate')?.hasError('required') && stage.value.stageId == 1">
                            La fecha inicia es <strong>requerido</strong>.
                          </mat-error>

                          <mat-error *ngIf="stageCalibration.get('startDate')?.hasError('required') && stage.value.stageId == 2">
                            La fecha inicia es <strong>requerido</strong>.
                          </mat-error>

                          <mat-error *ngIf="stageCalibration.get('startDate')?.hasError('matDatepickerMin') && stage.value.stageId == 2">
                            La fecha inicia debe ser <strong>mayor a la fecha termina de la etapa de evaluación</strong>.
                          </mat-error>

                        </mat-form-field>
                      </div>
                      <div
                        fxFlex.md="50"
                        fxFlex.lg="50"
                        fxFlex.xl="50"
                        fxFlex="100"
                      >
                        <mat-form-field
                          fxFill
                          appearance="outline"
                        >
                          <mat-label>Termina</mat-label>
                          <input
                            matInput
                            formControlName="endDate"
                            [min]="minDateComponentsEvaluation"
                            [max]="maxDateComponentsEvaluation"
                            [matDatepicker]="dpEvaluationStageEndDate"
                          >
                          <mat-datepicker-toggle
                            matSuffix
                            [for]="dpEvaluationStageEndDate">
                          </mat-datepicker-toggle>
                          <mat-datepicker #dpEvaluationStageEndDate></mat-datepicker>

                          <mat-error *ngIf="stageEvaluation.get('endDate')?.hasError('required') && stage.value.stageId == 1">
                            La fecha termina es <strong>requerido</strong>.
                          </mat-error>
                          <mat-error *ngIf="stageEvaluation.get('endDate')?.hasError('invalidDate') && stage.value.stageId == 1">
                            La fecha termina <strong>debe ser mayor que fecha inicia</strong>.
                          </mat-error>

                          <mat-error *ngIf="stageCalibration.get('endDate')?.hasError('required') && stage.value.stageId == 2">
                            La fecha termina es <strong>requerido</strong>.
                          </mat-error>
                          <mat-error *ngIf="stageCalibration.get('endDate')?.hasError('invalidDate') && stage.value.stageId == 2">
                            La fecha termina <strong>debe ser mayor que fecha inicia</strong>.
                          </mat-error>

                        </mat-form-field>
                      </div>
                    </div>
                  </mat-expansion-panel>
              </ng-container>
            </mat-accordion>

        </ng-template>

        <button
          color="primary"
          type="submit"
          mat-raised-button
        >
          {{textButton}}
        </button>
      </form>
    </section>
  </section>
</mat-card>
